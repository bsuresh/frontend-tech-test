<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Technical - test</title>
</head>
<style></style>
<body>
<header>
    <h1>Top 25 ranked cryptocurrencies</h1>
    <p>Please use the currency dropdown below to switch currencies.<br>You can also click on the column headings to sort
        asc/desc.</p>
</header>
<main>
    <div class="table-wrapper">
        <table data-js-cypto-table>
            <thead>
            <tr>
                <th data-key="id">ID</th>
                <th data-key="rank">Rank</th>
                <th data-key="priceUsd">Price</th>
                <th data-key="symbol">Symbol</th>
                <th data-key="explorer">Link</th>
            </tr>
            </thead>
            <tbody>
            <!-- Data Rows corresponding to the heading attribute `data-key` will be displayed here using JS -->
            </tbody>
        </table>
    </div>
    <p data-js-error-message></p>
</main>
<script>
    /**
     * A wrapper for class for FetchAPI for handling errors gracefully if it happens
     */
    class API {
        /**
         * @param url {string} - The URL to fetch data from
         */
        constructor(url) {
            this.url = url;
        }

        /**
         * Fetch data from the URL
         * @public
         * @returns {Promise<*>}
         */
        async fetchData() {
            try {
                const response = await fetch(this.url);
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                return error;
            }
        }
    }

    /**
     * Collection of utility functions
     */
    const Utils = {
        /**
         * Format price with currency
         * @param price
         * @param currency
         * @returns {string}
         */
        formatPrice: (price, currency) => {
            const priceFloat = parseFloat(price);
            if (!isNaN(priceFloat) && currency) {
                return `${priceFloat.toLocaleString('en-US', {
                    style: 'currency',
                    currency: currency,
                    maximumFractionDigits: 50
                })}`;
            } else {
                return 'N/A';
            }
        }
    };

    /**
     * Create table with data
     */
    class CreateTable {
        /**
         * @param data {Object} - The data to display in the table
         */
        constructor(data) {
            // Set local members
            this.data = data;
            this.tableElement = document.querySelector('[data-js-cypto-table]');
            this.currencySelectElement = document.querySelector('[data-js-currency-select]');
            this.currency = this.currencySelectElement?.value || 'USD';
            this.exchangeRatesAPIForUSD = new API('https://open.er-api.com/v6/latest/USD');

            this.init();
        }

        /**
         * Create table with data
         * @private
         */
        init() {
            this.createTable();
            this.bindEvents();
        }

        /**
         * Create table with data
         * @private
         */
        createTable() {
            if (this.data.error || !this.data.data) {
                this.showError();
                return;
            }

            let tableBodyElement = this.tableElement.querySelector('tbody');
            tableBodyElement.innerHTML = '';

            // loop through table headers and get data-key
            let tableHeadersElement = Array.from(this.tableElement.querySelectorAll('th')).map(header => header.dataset.key);

            // loop through data and create table rows
            this.data.data.forEach(row => {
                let tableRowElement = document.createElement('tr');
                tableHeadersElement.forEach(header => {
                    let tableDataElement = document.createElement('td');
                    // XSS/Crossite Risk,
                    // Very unsafe, but for the sake of this test, I'm assuming the data is safe
                    tableDataElement.innerHTML = this.formatColumnDataFor(header, row[header]);
                    // Add data attribute to td value
                    tableDataElement.dataset.value = row[header];
                    tableDataElement.dataset.key = header;
                    tableRowElement.appendChild(tableDataElement);
                });
                tableBodyElement.appendChild(tableRowElement);
            });

            // @todo add code to add rows to tbody
        }

        /**
         * Format column data
         * @private
         * @param key {string}
         * @param value {string|number}
         */
        formatColumnDataFor(key, value) {
            if (key === 'priceUsd') {
                return Utils.formatPrice(value, this.currency);
            }

            if (key === 'explorer') {
                return `<a href="${value}" target="_blank">Website â†’</a>`;
            }
            return value;
        }

        /**
         * Bind events
         * @private
         */
        bindEvents() {
            // @todo: Add bind events here for sorting and currency change elements
        }


        /**
         * Show error message if data is not available
         * @private
         */
        showError() {
            let errorMessageElement = document.querySelector('[data-js-error-message]');
            if (errorMessageElement) {
                errorMessage.textContent = this.data.error || 'Sorry! No data available. Please refresh this page to try again.';
            } else {
                console.error('Error:', this.data.error || 'Sorry! No data available. Please refresh this page to try again.');
            }
        }
    }

    // Wait for DOM ready or already loaded
    document.addEventListener('DOMContentLoaded', () => {
        // Fetch data from API and create table
        const coinCapAPI = new API('https://api.coincap.io/v2/assets');
        coinCapAPI.fetchData().then(data => {
            new CreateTable(data);
        });
    });
</script>
</body>
</html>